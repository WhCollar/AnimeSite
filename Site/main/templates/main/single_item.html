{% extends 'base.html' %}
{% load static %}


{% block title %}{{ block.super }} :: {{ title }}{% endblock %}
{% block content %}
<!-- CONTENT --------------------------------------------------------------------------------->
<!-- Intro Section -->
<section class="inner-intro dark-bg overlay-dark" xmlns="http://www.w3.org/1999/html">
    <div class="container">
        <div class="row">
            <div class="col-md-8 col-md-offset-2 title">
                <div class="col-md-5 col-sm-5 col-sm-offset-0 col-xs-12 col-xs-offset-0 mb-30">
                    {% if item.photo %}
                    <img alt="1" src="{{ item.photo.url }}" class="item-container">
                    {% else %}
                    <img alt="1" src="{% static 'img/page_404.png' %}" class="item-container">
                    {% endif %}
                    {% if user.is_authenticated %}
                    <form method="GET">
                        <div class="btn-group-custom">
                            {% csrf_token %}
                            <button class="btn-in-group-custom" value="1" style="width:30%">Смотрю</button>
                            <button class="btn-in-group-custom" value="2" style="width:40%;">Буду смотреть</button>
                            <button class="btn-in-group-custom" value="3" style="width:30%;">Брошено</button>
                        </div>
                    </form>
                    {% endif %}
                </div>
                <div class="col-md-6 col-sm-6 col-xs-12 text-center">
                    <h2 class="h2">{{ title }}</h2>
                    {% if user.is_authenticated %}
                    <div class='like'>
                        <form method="GET">
                            {% csrf_token %}
                            <button class='like-toggle basic2'>♥</button>
                            <span class='hidden-like-text' style="line-height:2;">Любимое</span>
                        </form>
                    </div>
                    {% else %}
                    <p style="color: #ff6666;">Зарегистрируйтесь, чтобы добавить аниме в свои списки {{ user.username }}</p>
                    {% endif %}
                    <p><strong></strong></p>
                    <div class="page-breadcrumb">
                        <a href="{% url 'home' %}}">Home</a>/<a href="{% url 'catalog' %}">Catalog</a>/<a>{{ title }}</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<div class="clearfix"></div>
<!-- End Intro Section -->
<!-- Options Section -->
<section class="ptb ptb-sm-80">
    <div class="container text-left">
        <div class="row mb-60">
            <div class="col-md-8 mb-30">
                {% if item.synopsis %}
                <p>{{ item.synopsis|safe }}</p>
                {% else %}
                <p>Админу было лень печатать. Прости (╥﹏╥) </p>
                {% endif %}
                <a class="scroll-to-target" onclick="getElementById('cv-tab').click();" href="#cv-tab">Read More</a>
            </div>
            <div class="project-detail-block col-md-4">
                {% if item.status %}
                <p>
                    <strong class="dark-color">Статус :</strong>{{ item.status }}
                </p>
                {% endif %}
                {% if item.year %}
                <p>
                    <strong class="dark-color">Год :</strong>{{ item.year }}
                </p>
                {% endif %}
                {% if item.season %}
                <p>
                    <strong class="dark-color">Сезон :</strong>{{ item.season }}
                </p>
                {% endif %}
                {% if item.age_rating %}
                <p>
                    <strong class="dark-color">Возрастной рейтинг :</strong>{{ item.age_rating }}
                </p>
                {% endif %}
                {% if item.genre %}
                <p>
                    <strong class="dark-color">Жанры :</strong>{% for g in item.genre.all %}{{ g.title }} {% endfor %}
                </p>
                {% endif %}
                {% if item.original_source %}
                <p>
                    <strong class="dark-color">Оригинальный источник :</strong>{{ item.original_source }}
                </p>
                {% endif %}
                {% if item.studio %}
                <p>
                    <strong class="dark-color">Студия :</strong>{{ item.studio }}
                </p>
                {% endif %}
                {% if item.director %}
                <p>
                    <strong class="dark-color">Режиссёр :</strong>{{ item.director }}
                </p>
                {% endif %}
                {% if item.content_type %}
                <p>
                    <strong class="dark-color">Тип :</strong>{{ item.content_type }}
                </p>
                {% endif %}
                {% if item.Number_of_episodes %}
                <p>
                    <strong class="dark-color">Серии :</strong>{{ item.Number_of_episodes }}
                </p>
                {% endif %}
                {% if item.dubbing_studio %}
                <p>
                    <strong class="dark-color">Озвучка :</strong>{% for s in item.dubbing_studio.all %}{{ s.title }} {% endfor %}
                </p>
                {% endif %}
            </div>

        </div>

        <div class="row">
            <div class="row col-md-12">
                <!-- Tab -->
                <div class="tabs mt-15">

                    <ul>
                        <li><a href="#tabs-1">Плеер</a></li>
                        <li><a id="cv-tab" href="#tabs-2">Коментарии</a></li>
                    </ul>

                    <div class="ui-tab-content">
                        <!-- Плеер -->
                        <div id="tabs-1">

                            <div class="">
                                <div class="row">
                                    <div class="col col-lg-5">
                                        <form>
                                            <div class="form-group">
                                                <label for="FormControlSelect1">Озвучка :</label>
                                                <select class="form-control" id="FormControlSelect1">
                                                    {% for s in item.dubbing_studio.all %}
                                                    <option value="{{ s.id }}">{{ s.title }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label for="FormControlSelect2">Плеер :</label>
                                                <select class="form-control" id="FormControlSelect2">
                                                </select>
                                            </div>
                                             <div class="form-group">
                                                <label for="FormControlSelect3">Эпизод :</label>
                                                <select class="form-control" id="FormControlSelect3">
                                                </select>
                                              </div>
                                        </form>
                                    </div>
                                    <div class="col col-lg-7" id="iframeBoxForVideo">
                                    </div>
                                </div>
                            </div>

                        </div>
                        <!-- End Плеер -->
                        <!-- Коментарии-->
                        <div id="tabs-2">
                            <p>{{ item.synopsis|safe }}</p>
                        </div>
                        <!--End Коментарии-->
                    </div>
                </div>
                <!-- End Tab -->
            </div>
        </div>
    </div>
</section>
<!-- End Options Section -->

<!-- CSS формы выбора озвучки, плеера и серии находится в файле stile.css -->

<!-- Данные для плеера -->
<div style="display:none" id="player_data">

    <div id="dubbing_studio_for_title">
        {% for i in item.iframe.all %}
        <div data-studio-title="{{ i.dubbing_studio.title }}" data-studio-id="{{ i.dubbing_studio.id }}">
            {% for j in item.iframe.all %}
            {% if i.dubbing_studio.id == j.dubbing_studio.id %}
            <div data-player-title="{{ j.video_player.title }}" data-player-id="{{ j.video_player.id }}"></div>
            {% endif %}
            {% endfor %}
        </div>
        {% endfor %}
    </div>

    <div id="iframes_for_player">

        {% for i in item.iframe.all %}
        <iframe src="{{ i.src }}" data-iframe-id="{{ i.id }}" data-iframe-dubbing-id="{{ i.dubbing_studio.id }}"
                data-iframe-player-id="{{ i.video_player.id }}" data-iframe-number-of-episodes="{{ i.number_of_episodes }}"
                width="100%" height="360" frameborder="0" allowfullscreen="" allow="autoplay *; fullscreen *"></iframe>
        {% endfor %}

    </div>

</div>
<!-- Конец Данные для плеера -->

<!-- Скрипт плеера -->
<script src="{% static 'js/video-selector.js' %}" type="text/javascript"></script>
<!-- Конец Скрипт плеера -->


<!-- AJAX для кнопок добавления в список -->
{% block javascript %}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        $(function() {
            $.ajax({
                url: "{% url 'item_ajax_buttons_validate' %}",
                data: {
                    'user_nickname': "{{ user.username }}",
                    'content_slug': "{{ item.slug }}",
                },
                success: function (response) {
                    console.log(response);
                    if (response.like_bool){
                        $('.like-toggle').toggleClass('like-active');
                        $('.like-toggle').next().toggleClass('hidden-like-text');
                    }
                    var btn;
                    var btnGroup = document.querySelector('.btn-group-custom');
                    if (response.watching_bool == true)
                    {
                        btn = btnGroup.querySelector('button[value="1"]');
                        $(btn).toggleClass('btn-in-group-custom-active');
                    }
                    if (response.will_be_watching_bool == true)
                    {
                        btn = btnGroup.querySelector('button[value="2"]');
                        $(btn).toggleClass('btn-in-group-custom-active');
                    }
                    if (response.abandoned_bool == true)
                    {
                        btn = btnGroup.querySelector('button[value="3"]');
                        $(btn).toggleClass('btn-in-group-custom-active');
                    }
                },
                error: function (response) {
                    console.log(response.responseJSON.errors);
                }
                });
            return false;
        });


        $(function(){
            $('.btn-in-group-custom').click(function(){
                var is_liked = false;
                var is_watching = false;
                var is_will_be_watching= false;
                var is_abandoned = false;

                var activeButtons = this.value;
                var buttons = document.querySelector('.btn-group-custom').querySelectorAll('button');
                for (let el of buttons){
                    if (el.value != activeButtons){
                        if (el.classList.contains('btn-in-group-custom-active'))
                        {
                            $(el).toggleClass('btn-in-group-custom-active');
                        }
                    }
                }
                $(this).toggleClass('btn-in-group-custom-active');

                var like_buttons = document.querySelector('.like-toggle');
                if (like_buttons.classList.contains('like-active'))
                {
                    is_liked = true;
                }
                else
                {
                    is_liked = false;
                }

                var is_batton_active = this.classList.contains('btn-in-group-custom-active');
                if (activeButtons == 1 && is_batton_active){ is_watching = true; };
                if (activeButtons == 2 && is_batton_active){ is_will_be_watching = true; };
                if (activeButtons == 3 && is_batton_active){ is_abandoned = true; };

                console.log(is_liked);
                console.log(is_watching);
                console.log(is_will_be_watching);
                console.log(is_abandoned);
                $.ajax({
                    url: "{% url 'item_ajax_buttons' %}",
                    data: {
                        'user_nickname': "{{ user.username }}",
                        'content_slug': "{{ item.slug }}",
                        'like_bool': is_liked,
                        'watching_bool': is_watching,
                        'will_be_watching_bool': is_will_be_watching,
                        'abandoned_bool': is_abandoned,
                    },
                    success: function (response) {
                    },
                    error: function (response) {
                        console.log(response.responseJSON.errors);
                    }
                    });
                return false;
            });
        });

        $(function(){
            $('.like-toggle').click(function(){
                $(this).toggleClass('like-active');
                $(this).next().toggleClass('hidden-like-text');

                var is_liked = false;
                var is_watching = false;
                var is_will_be_watching= false;
                var is_abandoned = false;

                if (this.classList.contains('like-active'))
                {
                    is_liked = true;
                }
                else
                {
                    is_liked = false;
                }

                var buttons = document.querySelector('.btn-group-custom').querySelectorAll('button');
                for (let el of buttons){
                    if (el.classList.contains('btn-in-group-custom-active'))
                    {
                        if (el.value == 1){ is_watching = true; };
                        if (el.value == 2){ is_will_be_watching = true; };
                        if (el.value == 3){ is_abandoned = true; };
                    }
                }

                console.log(is_liked);
                console.log(is_watching);
                console.log(is_will_be_watching);
                console.log(is_abandoned);
                $.ajax({
                    url: "{% url 'item_ajax_buttons' %}",
                    data: {
                        'user_nickname': "{{ user.username }}",
                        'content_slug': "{{ item.slug }}",
                        'like_bool': is_liked,
                        'watching_bool': is_watching,
                        'will_be_watching_bool': is_will_be_watching,
                        'abandoned_bool': is_abandoned,
                    },
                    success: function (response) {

                    },
                    error: function (response) {
                        console.log(response.responseJSON.errors);
                    }
                    });
                return false;
            });
        });

    </script>
{% endblock javascript %}
<!-- Конец AJAX для кнопок добавления в список -->


<!-- End CONTENT ------------------------------------------------------------------------------>
{% endblock %}
